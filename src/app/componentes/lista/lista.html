<div class="p-3 container">
  <div class="row">
    <div class="titulo col-5"><h1>Módulo de Cobranças</h1></div>
    <div class="col-6"></div>
    <div class="col-1">
      <button class="btn btn-primary titulo" routerLink="/">Voltar</button>
    </div>
  </div>

  <mat-accordion class="menu-acordeon">
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Filtros de busca</mat-panel-title>
      </mat-expansion-panel-header>

      <form [formGroup]="formFiltro" (ngSubmit)="aplicarFiltro()" class="row">
        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Nome do Beneficiário</mat-label>
          <input matInput formControlName="nome" placeholder="Nome completo" />
          <mat-error *ngIf="formFiltro.get('nome')?.hasError('minlength')">
            Mínimo 3 caracteres.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Código do Beneficiário</mat-label>
          <input
            matInput
            formControlName="cod_beneficiario"
            placeholder="Código do BEneficiario"
          />
          <mat-error
            *ngIf="formFiltro.get('cod_beneficiario')?.hasError('minlength')"
          >
            Mínimo 3 caracteres.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>CPF do Beneficiário</mat-label>
          <input matInput formControlName="cpf" placeholder="000.000.000-00" />
          <mat-error *ngIf="formFiltro.get('cpf')?.hasError('pattern')">
            Formato inválido (xxx.xxx.xxx-xx).
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Nome do PA</mat-label>
          <input matInput formControlName="nomePA" placeholder="Nome do PA" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>SR</mat-label>
          <mat-select formControlName="sr">
            @for (item of sr; track item) {
            <mat-option [value]="item">{{ item }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Situação</mat-label>
          <input matInput formControlName="situacao" placeholder="Situação" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Impedimento</mat-label>
          <input
            matInput
            formControlName="impedimento"
            placeholder="Impedimento"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-3">
          <mat-label>Modalidade</mat-label>
          <input
            matInput
            formControlName="modalidade"
            placeholder="Modalidade"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-6">
          <mat-label>Tipo</mat-label>
          <input matInput formControlName="tipo" placeholder="Tipo" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-6">
          <mat-label>Nosso Número (Boleto)</mat-label>
          <input
            matInput
            formControlName="nossoNumero"
            placeholder="Número do boleto"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-4">
          <mat-label>Número de Referência (GRU)</mat-label>
          <input
            matInput
            formControlName="numeroReferencia"
            placeholder="Número da GRU"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-4">
          <mat-label>Número do Processo</mat-label>
          <input
            matInput
            formControlName="numeroProcesso"
            placeholder="Número do processo"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="col-4">
          <mat-label>Nº do Documento de Titulação</mat-label>
          <input
            matInput
            formControlName="numeroDocumento"
            placeholder="Documento de titulação"
          />
        </mat-form-field>

        <div class="botoes-row">
          <button mat-flat-button color="primary" type="submit">Buscar</button>
          <button
            mat-stroked-button
            color="accent"
            type="button"
            (click)="limparFiltro()"
          >
            Limpar campos
          </button>
        </div>
      </form>
    </mat-expansion-panel>
  </mat-accordion>

  <br />

  <div
    class="table-toolbar my-2 d-flex align-items-center justify-content-between"
  >
    <div>
      <button
        mat-raised-button
        color="primary"
        [matMenuTriggerFor]="menuExportar"
      >
        Exportar
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
      <mat-menu #menuExportar="matMenu">
        <button mat-menu-item (click)="exportar('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>PDF</span>
        </button>
        <button mat-menu-item (click)="exportar('xls')">
          <mat-icon>grid_on</mat-icon>
          <span>XLS</span>
        </button>
        <button mat-menu-item (click)="exportar('csv')">
          <mat-icon>description</mat-icon>
          <span>CSV</span>
        </button>
      </mat-menu>
    </div>

    <div>
      <button
        mat-flat-button
        color="accent"
        (click)="imprimirGRU(selection.selected[0])"
        [disabled]="selection.selected.length === 0"
      >
        <mat-icon>print</mat-icon>
        Emitir GRU
      </button>
    </div>
  </div>

  <br />

  <div class="table-responsive">
    <table
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      class="mat-elevation-z8 w-100"
    >
      <!-- Coluna de seleção -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="$event ? masterToggle() : null"
            [checked]="isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
          ></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(row) : null"
            [checked]="selection.isSelected(row)"
          ></mat-checkbox>
        </td>
      </ng-container>

      <!-- Outras colunas -->
      <ng-container matColumnDef="cod_beneficiario">
        <th mat-header-cell *matHeaderCellDef>Código</th>
        <td mat-cell *matCellDef="let element">
          {{ element.titular.cod_beneficiario }}
        </td>
      </ng-container>

      <ng-container matColumnDef="nome">
        <th mat-header-cell *matHeaderCellDef>Nome</th>
        <td mat-cell *matCellDef="let element">{{ element.titular.nome }}</td>
      </ng-container>

      <ng-container matColumnDef="cpf">
        <th mat-header-cell *matHeaderCellDef>CPF</th>
        <td mat-cell *matCellDef="let element">{{ element.titular.cpf }}</td>
      </ng-container>

      <ng-container matColumnDef="nome_PA">
        <th mat-header-cell *matHeaderCellDef>Nome do PA</th>
        <td mat-cell *matCellDef="let element">
          {{ element.historico_PNRA?.[0]?.nome_PA || '-' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="sr">
        <th mat-header-cell *matHeaderCellDef>SR</th>
        <td mat-cell *matCellDef="let element">
          {{ element.requerimento?.[0]?.sr || '-' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="Situação">
        <th mat-header-cell *matHeaderCellDef>Situação</th>
        <td mat-cell *matCellDef="let element">
          {{ element.historico_PNRA?.[0]?.situacao || '-' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="Impedimento">
        <th mat-header-cell *matHeaderCellDef>Impedimento</th>
        <td mat-cell *matCellDef="let element">
          {{ element.bloqueios?.[0]?.bloqueio || '-' }}
        </td>
      </ng-container>

      <!-- Coluna de ações -->
      <ng-container matColumnDef="acoes">
        <th mat-header-cell *matHeaderCellDef>Ações</th>
        <td mat-cell *matCellDef="let element">
          <div class="d-flex align-items-center">
            <!-- Menu de Ações -->
            <button
              mat-icon-button
              [matMenuTriggerFor]="menuAcoes"
              (click)="abrirMenuAcoes($event, element)"
            >
              <mat-icon>more_vert</mat-icon>
            </button>

            <!-- Botão de Expandir -->
            <button
              mat-icon-button
              (click)="toggleExpand(element)"
              [class.expanded]="expandedElement === element"
            >
              <mat-icon>
                {{
                  expandedElement === element
                    ? "keyboard_arrow_up"
                    : "keyboard_arrow_down"
                }}
              </mat-icon>
            </button>
          </div>

          <mat-menu #menuAcoes="matMenu">
            <button mat-menu-item (click)="abrirDetalharDivida(element)">
              <span>Detalhes Do Beneficiário </span>
              <mat-icon>print</mat-icon>
            </button>
            <button mat-menu-item (click)="abrirConsultarDivida(element)">
              <span>Consultar Dívidas</span>
              <mat-icon>search</mat-icon>
            </button>
            <button mat-menu-item (click)="abrirCadastroConcessoes(element)">
              <span>Cadastrar Dívidas</span>
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-menu-item>
              <span>Dívidas</span>
              <mat-icon>request_quote</mat-icon>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Coluna da linha expandida -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="displayedColumns.length"
        >
          <div
            class="detail-container"
            [@detailExpand]="
              element === expandedElement ? 'expanded' : 'collapsed'
            "
          >
            <!-- TABELA DE DADOS DE COBRANÇA -->
            <table
              mat-table
              [dataSource]="element.dadosDeCobranca"
              class="w-100 mat-elevation-z2 linha-expandida"
            >
              <!-- Coluna de seleção -->
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef class="linha-expandida">
                  <mat-checkbox
                    (change)="$event ? masterToggleInner(element) : null"
                    [checked]="isAllSelectedInner(element)"
                    [indeterminate]="
                      element.innerSelection?.hasValue() &&
                      !isAllSelectedInner(element)
                    "
                  ></mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="linha-expandida">
                  <mat-checkbox
                    (click)="$event.stopPropagation()"
                    (change)="
                      $event ? toggleInnerSelection(element, row) : null
                    "
                    [checked]="element.innerSelection?.isSelected(row)"
                  ></mat-checkbox>
                </td>
              </ng-container>

              <!-- Coluna: Data do vencimento -->
              <ng-container
                matColumnDef="dataAssinaturaContrato"
                class="linha-expandida"
              >
                <th mat-header-cell *matHeaderCellDef class="linha-expandida">
                  Data do Vencimento
                </th>
                <td mat-cell *matCellDef="let d" class="linha-expandida">
                  {{ d.dataAssinaturaContrato }}
                </td>
              </ng-container>

              <!-- Coluna: Valor Contrato -->
              <ng-container
                matColumnDef="valorContrato"
                class="linha-expandida"
              >
                <th mat-header-cell *matHeaderCellDef class="linha-expandida">
                  Valor do Contrato
                </th>
                <td mat-cell *matCellDef="let d" class="linha-expandida">
                  {{ d.valorContrato | number : "1.2-2" }}
                </td>
              </ng-container>

              <!-- Coluna: Modalidade -->
              <ng-container matColumnDef="modalidade" class="linha-expandida">
                <th mat-header-cell *matHeaderCellDef class="linha-expandida">
                  Modalidade
                </th>
                <td mat-cell *matCellDef="let d" class="linha-expandida">
                  {{ d.modalidade }}
                </td>
              </ng-container>

              <!-- Cabeçalho e Linhas -->
              <tr
                mat-header-row
                *matHeaderRowDef="[
                  'select',
                  'dataAssinaturaContrato',
                  'valorContrato',
                  'modalidade'
                ]"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  columns: [
                    'select',
                    'dataAssinaturaContrato',
                    'valorContrato',
                    'modalidade'
                  ]
                "
              ></tr>
            </table>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: displayedColumns"
        (click)="toggleExpand(element)"
        class="row-click"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="expanded-row"
      ></tr>
    </table>
  </div>

  <mat-paginator
    [pageSizeOptions]="[10, 20]"
    showFirstLastButtons
  ></mat-paginator>
</div>
