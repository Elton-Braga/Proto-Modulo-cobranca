<div class="principal">
  <button class="btn btn-link btn-voltar" routerLink="/lista">Voltar</button>
  <br />
  <div class="filtro">
    <mat-accordion class="menu-acordeon">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Lista de boletos</mat-panel-title>
        </mat-expansion-panel-header>

        <form [formGroup]="formFiltro" (ngSubmit)="aplicarFiltro()" class="row">
          <mat-form-field appearance="outline" class="col-3">
            <mat-label>Nome do Devedor</mat-label>
            <input
              matInput
              formControlName="nome"
              placeholder="Nome completo"
            />
            <mat-error *ngIf="formFiltro.get('nome')?.hasError('minlength')">
              Mínimo 3 caracteres.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>Código do Devedor</mat-label>
            <input
              matInput
              formControlName="cod_beneficiario"
              placeholder="Código do devedor"
            />
            <mat-error
              *ngIf="formFiltro.get('cod_beneficiario')?.hasError('minlength')"
            >
              Mínimo 3 caracteres.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>CPF do devedor</mat-label>
            <input
              matInput
              formControlName="cpf"
              placeholder="000.000.000-00"
            />
            <mat-error *ngIf="formFiltro.get('cpf')?.hasError('pattern')">
              Formato inválido (xxx.xxx.xxx-xx).
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>Nome do PA</mat-label>
            <input matInput formControlName="nomePA" placeholder="Nome do PA" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>SR</mat-label>
            <mat-select formControlName="sr">
              @for (item of sr; track item) {
              <mat-option [value]="item">{{ item }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>Modalidade</mat-label>
            <input
              matInput
              formControlName="modalidade"
              placeholder="Modalidade"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>Tipo de receita</mat-label>
            <input matInput formControlName="tipo" placeholder="Tipo" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-3">
            <mat-label>Nosso Número (Boleto)</mat-label>
            <input
              matInput
              formControlName="nossoNumero"
              placeholder="Número do boleto"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-4">
            <mat-label>Número de Referência (GRU)</mat-label>
            <input
              matInput
              formControlName="numeroReferencia"
              placeholder="Número da GRU"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-4">
            <mat-label>Número do Processo</mat-label>
            <input
              matInput
              formControlName="numeroProcesso"
              placeholder="Número do processo"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-4">
            <mat-label>Nº do Documento de Titulação</mat-label>
            <input
              matInput
              formControlName="numeroDocumento"
              placeholder="Documento de titulação"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-6">
            <mat-label>Situação da receita</mat-label>
            <input
              matInput
              formControlName="situacao_receita"
              placeholder="Documento de titulação"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="col-6">
            <mat-label>Situação do PA</mat-label>
            <input
              matInput
              formControlName="situacao_PA"
              placeholder="Documento de titulação"
            />
          </mat-form-field>

          <div class="botoes-row">
            <button mat-flat-button color="primary" type="submit">
              Buscar
            </button>
            <button
              mat-stroked-button
              color="accent"
              type="button"
              (click)="limparFiltro()"
            >
              Limpar campos
            </button>
          </div>
        </form>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
  <br />
  <!-- Tabela de débitos / boletos -->
  <div class="tabela">
    <div
      class="table-toolbar"
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      "
    >
      <div style="display: flex; align-items: center; gap: 0.5rem">
        <!-- Botão Exportar com submenu -->
        <button
          mat-button
          [matMenuTriggerFor]="menuExportar"
          matTooltip="Exportar dados selecionados"
          (click)="$event.stopPropagation()"
        >
          <mat-icon>upload_file</mat-icon>
          Exportar
        </button>

        <mat-menu #menuExportar="matMenu">
          <button
            mat-menu-item
            (click)="exportarCSV()"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>table_view</mat-icon>
            <span>CSV</span>
          </button>

          <button
            mat-menu-item
            (click)="exportarPDF()"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>picture_as_pdf</mat-icon>
            <span>PDF</span>
          </button>
        </mat-menu>

        <!-- Contador de itens selecionados
        <span class="selected-count" *ngIf="selection?.hasValue()">
          {{ selection.selected.length }} selecionado(s)
        </span> -->
      </div>

      <!-- Botão Emitir GRU à direita -->
      <div>
        <button
          mat-raised-button
          color="primary"
          [disabled]="!selection.hasValue()"
          (click)="emitirGRUSelecionadas($event)"
          matTooltip="Emitir GRU para os itens selecionados"
        >
          <mat-icon>receipt_long</mat-icon>
          Emitir GRU
        </button>
      </div>
    </div>

    <!--<div class="table-toolbar margem-exportar">
      <button
        mat-button
        [matMenuTriggerFor]="menuExportar"
        matTooltip="Exportar dados selecionados"
      >
        <mat-icon>upload_file</mat-icon>
        Exportar
      </button>

      <mat-menu #menuExportar="matMenu">
        <button mat-menu-item (click)="exportarCSV()">
          <mat-icon>table_view</mat-icon>
          <span>CSV</span>
        </button>

        <button mat-menu-item (click)="exportarPDF()">
          <mat-icon>picture_as_pdf</mat-icon>
          <span>PDF</span>
        </button>
      </mat-menu>
      <span class="selected-count" *ngIf="selection?.hasValue()">
        {{ selection.selected.length }} selecionado(s)
      </span>
    </div>-->

    <br />
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z2" matSort>
      <!-- Checkbox (seleção) -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="$event ? masterToggle() : null"
            [checked]="isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            [aria-label]="checkboxLabel()"
          >
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? toggleRow(row) : null"
            [checked]="selection.isSelected(row)"
            [aria-label]="checkboxLabel(row)"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Código do beneficiário -->
      <ng-container matColumnDef="codigo">
        <th mat-header-cell *matHeaderCellDef>Código</th>
        <td mat-cell *matCellDef="let row">{{ row.codigoBeneficiario }}</td>
      </ng-container>

      <!-- Nome do devedor -->
      <ng-container matColumnDef="nome">
        <th mat-header-cell *matHeaderCellDef>Nome do Devedor</th>
        <td mat-cell *matCellDef="let row">{{ row.nomeDevedor }}</td>
      </ng-container>

      <!-- CPF do devedor -->
      <ng-container matColumnDef="cpf">
        <th mat-header-cell *matHeaderCellDef>CPF</th>
        <td mat-cell *matCellDef="let row">{{ row.cpfDevedor }}</td>
      </ng-container>

      <!-- Descrição da dívida -->
      <ng-container matColumnDef="descricao">
        <th mat-header-cell *matHeaderCellDef>Descrição da Dívida</th>
        <td mat-cell *matCellDef="let row">descrição da divida</td>
      </ng-container>

      <!-- Número da parcela -->
      <ng-container matColumnDef="parcela">
        <th mat-header-cell *matHeaderCellDef>Nº Parcela</th>
        <td mat-cell *matCellDef="let row">12</td>
      </ng-container>

      <!-- Vencimento -->
      <ng-container matColumnDef="vencimento">
        <th mat-header-cell *matHeaderCellDef>Vencimento</th>
        <td mat-cell *matCellDef="let row">
          {{ row.vencimento ? (row.vencimento | date : "dd/MM/yyyy") : "-" }}
        </td>
      </ng-container>

      <!-- Valor -->
      <ng-container matColumnDef="valor">
        <th mat-header-cell *matHeaderCellDef>Valor</th>
        <td mat-cell *matCellDef="let row">
          {{ row.valor != null ? (row.valor | number : "1.2-2") : "-" }}
        </td>
      </ng-container>

      <!-- Situação -->
      <ng-container matColumnDef="situacao">
        <th mat-header-cell *matHeaderCellDef>Situação</th>
        <td mat-cell *matCellDef="let row">pago</td>
      </ng-container>

      <!-- Ação -->
      <ng-container matColumnDef="acao">
        <th mat-header-cell *matHeaderCellDef>Ação</th>
        <td mat-cell *matCellDef="let row">
          <button
            mat-icon-button
            [matMenuTriggerFor]="menuAcoes"
            matTooltip="Ações"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #menuAcoes="matMenu">
            <button mat-menu-item (click)="emitirGRU(row)">
              <mat-icon>receipt_long</mat-icon>
              <span>Emitir GRU</span>
            </button>

            <button mat-menu-item (click)="detalharDivida(row)">
              <mat-icon>description</mat-icon>
              <span>Detalhar dívida</span>
            </button>

            <button mat-menu-item (click)="detalharDevedor(row)">
              <mat-icon>person_search</mat-icon>
              <span>Detalhar devedor</span>
            </button>

            <button mat-menu-item (click)="atualizarParcela(row)">
              <mat-icon>update</mat-icon>
              <span>Atualizar parcela</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Header e Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="toggleRow(row)"
      ></tr>
    </table>

    <!-- Paginator -->
    <mat-paginator
      [pageSize]="10"
      [pageSizeOptions]="[5, 10, 20]"
      showFirstLastButtons
    ></mat-paginator>
  </div>
</div>
